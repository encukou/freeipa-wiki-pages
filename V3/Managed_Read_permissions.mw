__NOTOC__

{{Admon/important|Work in progress|This design is not complete yet.
  However if you have any comments, please feel free to discuss them.}}

= Overview =

The IPA framework will handle default permissions more robustly with respect
to IPA updates and user-made changes.

In the future,
this allow us to create a system of fine-grained, user-controllable permissions
with good defaults and predictable behavior over upgrades.

= Use Cases =

No significant externally visible features are added;
this update will just ''enable'' a new, more restricted type of permissions.

No managed permissions will be actually added in this update;
that will be part of [https://fedorahosted.org/freeipa/ticket/3566 ticket #3566].
Also there is no way for the user to add their own managed permissions.

= Documentation draft =

This documentation draft explains the behavior from
the user's point of view:

"Managed" permissions are those permissions that come pre-installed with IPA,
and are updated in new releases to cover new functionality.
They behave like regular, user-created permissions, with these differences:

* Their name, location and target can not be modified
* They cannot be deleted (but note that setting default bindtype and removing from all privileges will effectively disable a permission)
* They have three sets of attributes:
** ''default'' attributes, managed by IPA, cannot be changed by the user
** ''included'' attributes (--includedattrs in the CLI) are extra attrs that the user has added
** ''excluded'' attributes (--excludedattrs in the CLI) are those that the user has removed

The permission applies to all attributes
that appear in either its ''default'' or ''included'' sets, but not in its
''excluded'' set.

Newer versions of IPA may add additional attributes to the ''default'' set.
Attributes added this way should be listed in the corresponding Release Notes.
If some of the new attributes are undesirable, add them to the corresponding
''excluded'' list before the upgrade.

Note that attributes of user-created permissions work the same way,
but since the ''default'' and ''excluded'' sets are empty,
only the ''included'' set determines the effective attributes.


= The problem =

Currently, updates to permissions that come with IPA are specified in .update
files.

This approach has the disadvantage that if the user modifies the permission,
the updater will not recognize it, so it will end up not being updated.
This may result in reduced functionality (if needed attributes are not
added), or security issues (if attributes are not deleted).


= Design =

== Managed Permissions ==

[[V3/Permissions_V2|V2 permissions]] with the
<tt>MANAGED</tt> flag set are called Managed permissions.

These permissions grant access to a set of attributes defined by IPA
and kept up-to-date on upgrades, while allowing users to add or remove
specific attributes from the default list.

The user can also manage the bind rule and privilege membership of Managed
permissions.

The other aspects of Managed permissions (name, location, target) are not
modifiable by the user.
The user cannot manually add new Managed permissions, or delete existing ones
(unless --force is applied; but later we may restrict this via ACIs).

To ensure that installing low-version replicas or disabling plugins does not
revoke access to existing data, the default list of attributes will be kept
in LDAP as <tt>ipaPermDefaultAttr</tt>.
Users can not modify this list via the framework.
On updates, new attributes will ''only'' be added to this list.
(To remove attributes, we would need to write a separate update plugin.)

There will be two attribute types
for holding attributes the admin added and removed:
<tt>ipaPermIncludedAttr</tt> and <tt>ipaPermExcludedAttr</tt> respectively.
(In user-created permissions,
<tt>ipaPermIncludedAttr</tt> is used for the same purpose as here,
and excluded & default are empty.)
See [[V3/Permissions V2]] for the schema definition.

When generating the ACI, the resulting attribute list will be
computed by taking the <tt>ipaPermDefaultAttr</tt> set,
adding any <tt>ipaPermIncludedAttr</tt>s,
and then removing any <tt>ipaPermExcludedAttr</tt>s.

For example, this permission:

 dn: cn=Read Users,cn=permissions,cn=pbac,$SUFFIX
 cn: Read Users
 ipaPermDefaultAttr: cn
 ipaPermDefaultAttr: sn
 ipaPermDefaultAttr: givenName
 ipaPermDefaultAttr: l
 ...
 ipaPermIncludedAttr: favoriteColor
 ipaPermExcludedAttr: givenName
 objectClass: top
 objectClass: groupOfNames
 objectclass: ipaPermission
 objectclass: ipaManagedPermission
 ipaPermType: SYSTEM
 ipaPermType: V2
 ipaPermType: MANAGED
 ipaPermLocation: cn=users,cn=accounts,$SUFFIX
 ipaPermRight: read
 ipaPermTarget: uid=*,cn=users,cn=accounts,$SUFFIX
 ipaPermBindRuleType: permission

would allow users to read all default user attributes except
<tt>givenName</tt>, plus additionally <tt>favoriteColor</tt>.

=== CLI & API ===

The <tt>permission-{mod,find}</tt> commands will gain two new options,
<tt>--includedattrs</tt> (API: <tt>ipapermincludedattr</tt>) and
<tt>--excludedattrs</tt> (API: <tt>ipapermexcludedattr</tt>).
For <tt>permission-mod</tt> it is an error to use <tt>--excludedattrs</tt>
with non-managed permissions.

For a managed permission, the <tt>permission-{mod,find,show}</tt> commands
will output all three
lists (<tt>ipapermdefaultattr</tt>, <tt>ipapermallowedattr</tt>,
<tt>ipapermexcludedattr</tt>),
as well as the computed list of effective attributes.

For a non-managed permission, <tt>permission-{mod,find,show}</tt>
will only output the effective attributes (<tt>attrs</tt>).
With <tt>--all</tt>, the included attributes will also be included.
As any missing attribute course excluded and default will not be output.
With <tt>--raw</tt>, only <tt>ipaPermIncludedAttr</tt>, and not <tt>attrs</tt>,
wil be output.

It is an error to set the <tt>ipapermlocation</tt>,
<tt>ipapermtargetfilter</tt>, or <tt>ipapermtarget</tt>
of a managed permission.
(This means that it's an error to ise the API options <tt>subtree</tt>,
<tt>filter</tt>, <tt>target</tt>, <tt>memberof</tt>, <tt>targetgroup</tt>,
or <tt>type</tt> with a managed permission.)

== Default Permission Updater ==

A server post-update plugin will walk through ipalib <tt>Object</tt> plugins
and create/update managed permissions pertaining to them.

Names of such default permissions are ''required'' to start with "System: ",
so that default permissions added in future IPA releases do not conflict
with user-created permissions.
The ":" character will not be usable in <tt>permission-add</tt>.
(It will be usable in <tt>permission-mod</tt> and <tt>permission-del</tt>,
where managed permissions are subject to the limitations stated above.)

The IPA Object plugins will gain a new Python attribute,
<tt>managed_permissions</tt>, which will hold a template for the permissions
that are to be added by default to manage that object.

This will allow plugins to be more self-contained; it will no longer be
necessary to modify IPA's update files to add the common cases
of plugin-specific permissions.

The <tt>objectclass</tt>, <tt>ipapermlocation</tt> and an objectclass filter
will be added to the default permission as if
<tt>permission-add</tt> was used with the corresponding <tt>--type</tt>.

The flags (<tt>ipapermissiontype</tt>) will be set to <tt>SYSTEM, V2, MANAGED</tt>.

Other attributes of the Permission will be taken from the
<tt>managed_permissions</tt> template.
For example, the entry for the netgroup plugin would look like this:

    managed_permissions = {
        'System: Read Netgroups': {
            'ipapermbindruletype': 'all',
            'ipapermright': {'read', 'search', 'compare'},
            'ipapermdefaultattr': {
                'cn', 'description', 'hostcategory', 'ipaenabledflag',
                'ipauniqueid', 'nisdomainname', 'usercategory'
            },
            'replaces_global_anonymous_aci': True,
        },
        'System: Read Netgroup Membership': {
            'ipapermbindruletype': 'all',
            'ipapermright': {'read', 'search', 'compare'},
            'ipapermdefaultattr': {
                'externalhost', 'member', 'memberof', 'memberuser'
            },
            'replaces_global_anonymous_aci': True,
        },
    }

; ipapermbindruletype, ipapermright
: Directly used as attributes on the permission.
; ipapermdefaultattr
: Used as attribute of the permission.
: When upgrading, only new values are added, all old values are kept.
: (This means installing/updating to a low-version replica will not remove permissions.)
; replaces_global_anonymous_aci
: If true, any attributes specified (denied) in the legacy global anonymous read ACI will be added to excluded_attributes of the new permission.
: Has no effect when existing permissions are updated.

TODO: There will also be a list of default permissions not bound to an Object.
It will be processed in the same way, but the template will have explicit
<tt>ipapermlocation</tt> and <tt>ipapermfilter</tt>.

=== Replacing legacy default permissions ===

Another entry in the <tt>managed_permissions</tt>template,
<tt>replaces</tt>, will be used for
replacing legacy permissions with new managed ones. Example:

    managed_permissions = {
        'ipa:Modify SUDO Rule': {
            'ipapermbindruletype': 'permission',
            'ipapermright': {'write'},
            'ipapermdefaultattr': {
                'description', 'ipaenabledflag', 'usercategory',
                'hostcategory', 'cmdcategory', 'ipasudorunasusercategory',
                'ipasudorunasgroupcategory', 'externaluser',
                'ipasudorunasextuser', 'ipasudorunasextgroup', 'memberdenycmd',
                'memberallowcmd', 'memberuser'
            },
            'replaces': {
                'cn': 'Modify Sudo rule',
                'ipapermincludedattr': {
                    'description', 'ipaenabledflag', 'usercategory',
                    'hostcategory', 'cmdcategory', 'ipasudorunasusercategory',
                    'ipasudorunasgroupcategory', 'externaluser',
                    'ipasudorunasextuser', 'ipasudorunasextgroup',
                    'memberdenycmd', 'memberallowcmd', 'memberuser'
                },
                'ipapermtarget': DN('ipauniqueid=*', 'cn=sudorules',
                                    'cn=sudo', api.env.suffix),
            }
        },
        ...

If the new managed permission does not exist yet,
''and'' an existing legacy permission exists either without an associated ACI
or with an ACI that ''exactly'' matches the information specified
in the <tt>replaces</tt> dict,
a special upgrade process is followed:

* The ACI for the managed permission is added (without permission entry)
* The ACI for the existing permission is deleted
* The existing permission entry is deleted
* The managed permission entry is added

This ensures that

* the old permission is retained if the user has changed it
* at no time are the permissions revoked
* when restarted after failure (e.g. loss of power), the upgrade process will finish correctly

If the new managed permission does not exist yet,
and an existing legacy permission does matches <tt>cn</tt>
but ''not'' some other attributes in the <tt>replaces</tt> dict,
a warning is logged,
the new permission is added,
and the old one is left in place.

To reduce clutter, the old permission info will be stored in a different file:

 from ipalib.legacy import legacy_permissions

    ...
        'replaces': legacy_permissions.modify_sudo_rule,
    ...

=== Removing the global anonymous read ACI ===

After the permission updater successfully runs, it will look for an ACI
named "Enable Anonymous access" in $SUFFIX, and remove it.

The <tt>update_anonymous_aci</tt> server update plugin will be removed.


== ACI.txt ==

{{Admon/note|TODO|Flesh this out more. Possibly combine with an
[https://fedorahosted.org/freeipa/ticket/4035 ACI audit tool].}}

To ensure that permission changes are properly reviewed, a summary file
similar to API.txt will be generated, and it will be checked on each build.

It will contain a summary of the default managed permissions.

A <tt>makeaci</tt> script similar to <tt>makeapi</tt> will be provided and
called to check the file on each build.

= Implementation =

No additional requirements or changes discovered during the implementation phase.

= Feature Managment =

=== UI ===

TODO: Managed permissions will need UI changes

=== CLI ===

See the CLI & API section in Design.

= Major configuration options and enablement =

Access control is configured via the existing RBAC system.

= Replication =

N/A, ACIs and permissions are replicated.

= Updates and Upgrades =

Old servers will not be able to modify Managed permissions,
except adding/removing them to/from prigileges.
Details are in [[V3/Permissions_V2|Permissions V2]],
which will be implemented in the same release.
Managed permissions use the MANAGED flag.

= Dependencies =

No new package and library dependencies.

= External Impact =

Tests and documentation need to be written.

= Backup and Restore =

ACIs, permissions, privileges and roles are already included in backup & restore.

= Test Plan =

{{Admon/note|TODO|Tests for plugin-configured permissions, and for updates}}

{{:V3/Managed Read permissions/tests}}

= RFE Author =

[[User:Pviktorin|Petr Viktorin]]
